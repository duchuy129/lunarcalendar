<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ext="clr-namespace:LunarCalendar.MobileApp.Extensions"
             xmlns:converters="clr-namespace:LunarCalendar.MobileApp.Converters"
             xmlns:viewmodels="clr-namespace:LunarCalendar.MobileApp.ViewModels"
             x:Class="LunarCalendar.MobileApp.Views.ZodiacCompatibilityPage"
             Title="{Binding Title}"
             Background="{DynamicResource BackgroundGradient}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
            <converters:IntTo0to1Converter x:Key="IntTo0to1Converter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Header -->
            <VerticalStackLayout Spacing="6" Margin="0,8,0,0">
                <Label Text="☯️"
                       FontSize="40"
                       HorizontalOptions="Center"/>
                <Label Text="{ext:Translate ZodiacCompatibility}"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray900}"
                       HorizontalOptions="Center"/>
                <Label Text="{ext:Translate ZodiacCompatibilityDesc}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray600}"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center"/>
            </VerticalStackLayout>

            <!-- Animal Selector Card -->
            <Border Padding="20"
                    Background="{DynamicResource CardGradient}"
                    StrokeThickness="0">
                <Border.Shadow>
                    <Shadow Brush="Black"
                            Opacity="0.08"
                            Radius="12"
                            Offset="0,4"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="16">

                    <!-- Animal 1 Picker -->
                    <VerticalStackLayout Spacing="6">
                        <Label Text="{ext:Translate SelectFirstAnimal}"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource Gray600}"/>
                        <Border Padding="4,2"
                                BackgroundColor="{DynamicResource Gray100}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray300}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding AllAnimals}"
                                    SelectedItem="{Binding SelectedAnimal1}"
                                    ItemDisplayBinding="{Binding DisplayName}"
                                    FontSize="16"
                                    TextColor="{DynamicResource Gray900}"
                                    HorizontalOptions="Fill"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- VS Label -->
                    <Label Text="VS"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Primary}"
                           HorizontalOptions="Center"/>

                    <!-- Animal 2 Picker -->
                    <VerticalStackLayout Spacing="6">
                        <Label Text="{ext:Translate SelectSecondAnimal}"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{DynamicResource Gray600}"/>
                        <Border Padding="4,2"
                                BackgroundColor="{DynamicResource Gray100}"
                                StrokeThickness="1"
                                Stroke="{DynamicResource Gray300}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10"/>
                            </Border.StrokeShape>
                            <Picker ItemsSource="{Binding AllAnimals}"
                                    SelectedItem="{Binding SelectedAnimal2}"
                                    ItemDisplayBinding="{Binding DisplayName}"
                                    FontSize="16"
                                    TextColor="{DynamicResource Gray900}"
                                    HorizontalOptions="Fill"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Check Button -->
                    <Button Text="{ext:Translate CheckCompatibility}"
                            Command="{Binding CheckCompatibilityCommand}"
                            IsEnabled="{Binding IsCalculating, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="{DynamicResource Primary}"
                            TextColor="White"
                            CornerRadius="12"
                            FontAttributes="Bold"
                            FontSize="16"
                            HeightRequest="52"
                            HorizontalOptions="Fill">
                        <Button.Shadow>
                            <Shadow Brush="{DynamicResource Primary}"
                                    Opacity="0.3"
                                    Radius="8"
                                    Offset="0,3"/>
                        </Button.Shadow>
                    </Button>

                    <!-- Loading indicator -->
                    <ActivityIndicator IsRunning="{Binding IsCalculating}"
                                       IsVisible="{Binding IsCalculating}"
                                       Color="{DynamicResource Primary}"
                                       HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>

            <!-- Result Card (only visible when HasResult) -->
            <Border Padding="20"
                    Background="{DynamicResource CardGradient}"
                    StrokeThickness="0"
                    IsVisible="{Binding HasResult}">
                <Border.Shadow>
                    <Shadow Brush="Black"
                            Opacity="0.1"
                            Radius="14"
                            Offset="0,5"/>
                </Border.Shadow>
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="16">

                    <!-- Result title -->
                    <Label Text="{ext:Translate CompatibilityResultTitle}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Gray600}"
                           HorizontalOptions="Center"/>

                    <!-- Emoji pair -->
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
                        <Label Text="{Binding ResultEmoji1}"
                               FontSize="48"/>
                        <Label Text="❤️"
                               FontSize="32"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding ResultEmoji2}"
                               FontSize="48"/>
                    </HorizontalStackLayout>

                    <!-- Animal pair name -->
                    <Label Text="{Binding ResultAnimalPair}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Gray900}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"/>

                    <!-- Score + Rating row -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                        <!-- Score -->
                        <Border Grid.Column="0"
                                Padding="12,10"
                                BackgroundColor="{DynamicResource Gray50}"
                                StrokeThickness="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                <Label Text="{ext:Translate CompatibilityScore}"
                                       FontSize="11"
                                       TextColor="{DynamicResource Gray500}"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding ResultScore, StringFormat='{0}/100'}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="{Binding ResultRatingColor}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Rating -->
                        <Border Grid.Column="1"
                                Padding="12,10"
                                BackgroundColor="{DynamicResource Gray50}"
                                StrokeThickness="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <VerticalStackLayout Spacing="2" HorizontalOptions="Center">
                                <Label Text="{ext:Translate CompatibilityRating}"
                                       FontSize="11"
                                       TextColor="{DynamicResource Gray500}"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"/>
                                <Label Text="{Binding ResultRatingLocalized}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="{Binding ResultRatingColor}"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Score bar -->
                    <VerticalStackLayout Spacing="4">
                        <ProgressBar Progress="{Binding ResultScore, Converter={StaticResource IntTo0to1Converter}}"
                                     ProgressColor="{Binding ResultRatingColor}"
                                     BackgroundColor="{DynamicResource Gray200}"
                                     HeightRequest="10"/>
                    </VerticalStackLayout>

                    <BoxView HeightRequest="1"
                             BackgroundColor="{DynamicResource Gray200}"/>

                    <!-- Description -->
                    <Label Text="{Binding ResultDescription}"
                           FontSize="14"
                           TextColor="#4B5563"
                           LineBreakMode="WordWrap"
                           HorizontalTextAlignment="Center"/>
                </VerticalStackLayout>
            </Border>

            <!-- Bottom padding -->
            <BoxView HeightRequest="20" Color="Transparent"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
