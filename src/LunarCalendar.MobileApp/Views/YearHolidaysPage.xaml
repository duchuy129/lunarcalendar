<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LunarCalendar.MobileApp.ViewModels"
             xmlns:models="clr-namespace:LunarCalendar.MobileApp.Models"
             xmlns:strings="clr-namespace:LunarCalendar.MobileApp.Resources.Strings"
             xmlns:converters="clr-namespace:LunarCalendar.MobileApp.Converters"
             x:Class="LunarCalendar.MobileApp.Views.YearHolidaysPage"
             x:DataType="viewmodels:YearHolidaysViewModel"
             Title="{x:Static strings:AppResources.YearHolidays}"
             Background="{DynamicResource BackgroundGradient}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="0">

        <!-- Year Navigation Section -->
        <Border Grid.Row="0"
                Margin="16,16,16,8"
                StrokeThickness="0"
                Background="{DynamicResource PrimaryGradientVertical}">
            <Border.Shadow>
                <Shadow Brush="Black"
                        Opacity="0.1"
                        Radius="8"
                        Offset="0,2"/>
            </Border.Shadow>
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12"/>
            </Border.StrokeShape>

            <Grid Padding="12" ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                <!-- Previous Year Button -->
                <Border Grid.Column="0"
                        BackgroundColor="#40FFFFFF"
                        StrokeThickness="0"
                        Padding="0"
                        WidthRequest="50"
                        HeightRequest="44">
                    <Border.Shadow>
                        <Shadow Brush="White"
                                Opacity="0.15"
                                Radius="6"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding PreviousYearCommand}"/>
                    </Border.GestureRecognizers>
                    <Label Text="‹"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>

                <!-- Year Picker -->
                <Border Grid.Column="1"
                        BackgroundColor="White"
                        StrokeThickness="0"
                        Padding="12,0"
                        HeightRequest="44">
                    <Border.Shadow>
                        <Shadow Brush="Black"
                                Opacity="0.1"
                                Radius="6"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Picker ItemsSource="{Binding AvailableYears}"
                            SelectedItem="{Binding SelectedYear}"
                            FontSize="17"
                            FontAttributes="Bold"
                            TextColor="{DynamicResource Primary}"
                            BackgroundColor="Transparent"
                            HorizontalOptions="Fill"
                            VerticalOptions="Center"/>
                </Border>

                <!-- Current Year Button -->
                <Border Grid.Column="2"
                        BackgroundColor="#40FFFFFF"
                        StrokeThickness="0"
                        Padding="16,8">
                    <Border.Shadow>
                        <Shadow Brush="White"
                                Opacity="0.15"
                                Radius="6"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding CurrentYearCommand}"/>
                    </Border.GestureRecognizers>
                    <Label Text="{Binding TodayButtonText}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>

                <!-- Next Year Button -->
                <Border Grid.Column="3"
                        BackgroundColor="#40FFFFFF"
                        StrokeThickness="0"
                        Padding="0"
                        WidthRequest="50"
                        HeightRequest="44">
                    <Border.Shadow>
                        <Shadow Brush="White"
                                Opacity="0.15"
                                Radius="6"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding NextYearCommand}"/>
                    </Border.GestureRecognizers>
                    <Label Text="›"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Border>
            </Grid>
        </Border>

        <!-- Holidays List -->
        <Border Grid.Row="1"
                Margin="16,8,16,16"
                StrokeThickness="0"
                Background="{DynamicResource CardGradient}">
            <Border.Shadow>
                <Shadow Brush="Black"
                        Opacity="0.1"
                        Radius="12"
                        Offset="0,4"/>
            </Border.Shadow>
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16"/>
            </Border.StrokeShape>

            <Grid>
                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                 IsVisible="{Binding IsLoading}"
                                 Color="{DynamicResource Primary}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"/>

                <!-- Holidays CollectionView - ONLY created when NOT loading -->
                <!-- This completely removes CollectionView from visual tree during updates -->
                <ContentView IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
                    <CollectionView ItemsSource="{Binding YearHolidays}"
                                   Margin="16,8">
                        <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               Padding="20">
                                <Label Text="{x:Static strings:AppResources.NoHolidaysFound}"
                                      FontSize="14"
                                      TextColor="{DynamicResource Gray600}"
                                      HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:LocalizedHolidayOccurrence">
                            <Border Padding="14"
                                   Margin="0,6"
                                   BackgroundColor="White"
                                   StrokeThickness="0">
                                <Border.Shadow>
                                    <Shadow Brush="Black"
                                            Opacity="0.08"
                                            Radius="8"
                                            Offset="0,2"/>
                                </Border.Shadow>
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12"/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:YearHolidaysViewModel}}, Path=NavigateToHolidayDetailCommand}"
                                                         CommandParameter="{Binding .}"/>
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="Auto,*"
                                     ColumnSpacing="12">

                                    <!-- Date Box - Elegant Soft Gradient Design -->
                                    <Border Grid.Column="0"
                                           Padding="12,14"
                                           StrokeThickness="0"
                                           WidthRequest="70">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                <GradientStop Color="{Binding ColorHex}" Offset="0.0"/>
                                                <GradientStop Color="{Binding ColorHex}" Offset="1.0"/>
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <Border.Shadow>
                                            <Shadow Brush="{Binding ColorHex}"
                                                    Opacity="0.25"
                                                    Radius="12"
                                                    Offset="0,4"/>
                                        </Border.Shadow>
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="14"/>
                                        </Border.StrokeShape>
                                        <VerticalStackLayout HorizontalOptions="Center" Spacing="0">
                                            <Label Text="{Binding GregorianDate, StringFormat='{0:MMM}'}"
                                                  FontSize="10"
                                                  TextColor="White"
                                                  Opacity="0.95"
                                                  FontAttributes="Bold"
                                                  HorizontalOptions="Center"
                                                  Margin="0,0,0,2"/>
                                            <Label Text="{Binding GregorianDate, StringFormat='{0:dd}'}"
                                                  FontSize="26"
                                                  FontAttributes="Bold"
                                                  TextColor="White"
                                                  HorizontalOptions="Center"
                                                  Margin="0,0,0,2"/>
                                            <Label Text="{Binding GregorianDate, StringFormat='{0:yyyy}'}"
                                                  FontSize="9"
                                                  TextColor="White"
                                                  Opacity="0.85"
                                                  HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </Border>

                                    <!-- Holiday Info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                        Spacing="4"
                                                        VerticalOptions="Center">
                                        <Label Text="{Binding HolidayName}"
                                              FontSize="16"
                                              FontAttributes="Bold"
                                              TextColor="{DynamicResource Gray900}"/>

                                        <Label Text="{Binding GregorianDateFormatted}"
                                              FontSize="12"
                                              TextColor="{DynamicResource Gray600}"/>

                                        <!-- Lunar date display -->
                                        <Label Text="{Binding LunarDateDisplay}"
                                              FontSize="14"
                                              TextColor="{DynamicResource LunarRed}"
                                              FontAttributes="Bold"
                                              Margin="0,4,0,0"
                                              IsVisible="{Binding HasLunarDate}"/>

                                        <Label Text="{Binding HolidayDescription}"
                                              FontSize="11"
                                              TextColor="{DynamicResource Gray500}"
                                              LineBreakMode="WordWrap"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                </ContentView>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
