<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LunarCalendar.MobileApp.ViewModels"
             x:Class="LunarCalendar.MobileApp.Views.CalendarPage"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto"
          Padding="0">

        <!-- Month Navigation Header -->
        <Grid Grid.Row="0"
              Padding="16,8"
              BackgroundColor="{DynamicResource Primary}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0"
                    Text="◀"
                    Command="{Binding PreviousMonthCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    FontSize="20"
                    WidthRequest="50"/>

            <Label Grid.Column="1"
                   Text="{Binding MonthYearDisplay}"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="White"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"/>

            <Button Grid.Column="2"
                    Text="Today"
                    Command="{Binding TodayCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    FontSize="14"
                    Padding="8,0"
                    Margin="0,0,8,0"/>

            <Button Grid.Column="3"
                    Text="▶"
                    Command="{Binding NextMonthCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    FontSize="20"
                    WidthRequest="50"/>
        </Grid>

        <!-- Day of Week Header -->
        <Grid Grid.Row="1"
              Padding="4,8"
              BackgroundColor="{DynamicResource Gray100}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Label Grid.Column="0" Text="Sun" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="1" Text="Mon" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="2" Text="Tue" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="3" Text="Wed" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="4" Text="Thu" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="5" Text="Fri" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
            <Label Grid.Column="6" Text="Sat" HorizontalOptions="Center" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Gray600}"/>
        </Grid>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="3"
                          IsVisible="{Binding IsBusy}"
                          IsRunning="{Binding IsBusy}"
                          Color="{DynamicResource Primary}"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"/>

        <!-- Calendar Grid -->
        <CollectionView Grid.Row="3"
                       ItemsSource="{Binding CalendarDays}"
                       IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                       SelectionMode="None">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical"
                               Span="7"/>
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Padding="4"
                           Margin="2">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8"/>
                        </Border.StrokeShape>
                        <Border.Triggers>
                            <DataTrigger TargetType="Border"
                                       Binding="{Binding IsToday}"
                                       Value="True">
                                <Setter Property="BackgroundColor" Value="{DynamicResource Primary}"/>
                            </DataTrigger>
                        </Border.Triggers>

                        <VerticalStackLayout Spacing="2"
                                           Padding="4">
                            <!-- Gregorian Day -->
                            <Label Text="{Binding Day}"
                                  FontSize="16"
                                  FontAttributes="Bold"
                                  HorizontalOptions="Center">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label"
                                               Binding="{Binding IsCurrentMonth}"
                                               Value="False">
                                        <Setter Property="TextColor" Value="{DynamicResource Gray300}"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label"
                                               Binding="{Binding IsToday}"
                                               Value="True">
                                        <Setter Property="TextColor" Value="White"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>

                            <!-- Lunar Day -->
                            <Label Text="{Binding LunarDateDisplay}"
                                  FontSize="10"
                                  TextColor="Red"
                                  HorizontalOptions="Center"
                                  LineBreakMode="NoWrap">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label"
                                               Binding="{Binding IsCurrentMonth}"
                                               Value="False">
                                        <Setter Property="TextColor" Value="{DynamicResource Gray300}"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label"
                                               Binding="{Binding IsToday}"
                                               Value="True">
                                        <Setter Property="TextColor" Value="White"/>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label"
                                               Binding="{Binding LunarDateDisplay}"
                                               Value="">
                                        <Setter Property="IsVisible" Value="False"/>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </VerticalStackLayout>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Bottom Info -->
        <Label Grid.Row="4"
               Text="{Binding UserModeText}"
               FontSize="12"
               TextColor="{DynamicResource Gray600}"
               HorizontalOptions="Center"
               Padding="0,12"/>

    </Grid>
</ContentPage>
